\documentclass{article}
\input{test2e}

% Use case for meta family:
% 
%   Most fonts do not have ipa symbols so you may have to select a
%   matching font family when typsetting ipa chars. and that should
%   change when you change to a different meta family.
% 
%   \ipa is the command to turn on IPA typesetting and subsequent
%   \XXfamily commands should switch to a matching IPA font.
% 
%   \normalfont would turn IPA typesetting off (and so would any scop
%   restriction)
% 
% To avoid loading all kind of fonts into the test suite we mimic the
% IPA fonts by using colored fonts instead.


\ifx\directlua\undefined  \expandafter \stop  \fi  % this test is only for luatex!

\usepackage{fontspec}

\newfontfamily\iparm{Latin Modern Roman}[NFSSFamily=iparm,Color=red]
\newfontfamily\ipasf{Latin Modern Sans}[NFSSFamily=ipasf,Color=green]
\newfontfamily\ipatt{Latin Modern Mono}[NFSSFamily=ipatt,Color=blue]

\newfontfamily\tgtermes{TeX Gyre Termes}[NFSSFamily=tgtermes]   % as a font not one of the meta families


% the IPA command:

\newif\ifipa
\makeatletter
\def\ipa{\ipatrue \@reinitializemetafamily }

\def\showmetafamily{(meta is'\@currentmetafamily') } % for testing


\makeatother

\AddToHook{rmfamily}{\ifipa \fontfamily{iparm}\fi}
\AddToHook{sffamily}{\ifipa \fontfamily{ipasf}\fi}
\AddToHook{ttfamily}{\ifipa \fontfamily{ipatt}\fi}

\AddToHook{normalfont}{\ipafalse}

\showoutput

\begin{document}

\START

\showmetafamily

Hello world {\ipa \showmetafamily Hello \sffamily\bfseries \showmetafamily world} \showmetafamily hello world

\sffamily \showmetafamily Hello world {\ipa Hello world}  

% meta doesn't change
\fontfamily{tgtermes}\selectfont \showmetafamily Hello World {\ipa \showmetafamily Hello World} 

\ttfamily Hello world \ipa \showmetafamily Hello world \normalfont Hello world in Roman


\newpage
\OMIT
\end{document}
